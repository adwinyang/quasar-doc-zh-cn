"use strict";(globalThis["webpackChunkquasar_dev"]=globalThis["webpackChunkquasar_dev"]||[]).push([[72799],{72799:(n,s,e)=>{e.r(s),e.d(s,{default:()=>N});var o=e(83673);const a=(0,o._)("p",null,'编写 "通用 "代码(也称为 “同构”)意味着编写在服务器和客户端都能运行的代码。由于使用情况和平台API的不同，我们的代码在不同环境下运行时的行为不会完全相同。这里我们将介绍一下你需要注意的关键事项。',-1),t=(0,o.Uk)("! "),c=(0,o.Uk)("Quasar SSR Build System"),l=(0,o._)("p",null,"在一个纯客户端的应用中，每个用户都会在他们的浏览器中使用一个新的应用实例。对于服务器端的渲染，我们也希望如此：每个请求都应该有一个新鲜的、孤立的应用程序实例，这样就不会有跨请求的状态污染。",-1),k=(0,o._)("p",null,'因为实际的渲染过程需要确定性，我们也将在服务器上 "预取 "数据–这意味着当我们开始渲染时，我们的应用状态已经被解决。这意味着数据反应性在服务器上是不必要的，所以它在默认情况下是禁用的。禁用数据反应性也避免了将数据转换为反应性对象的性能成本。',-1),p=(0,o._)("p",null,[(0,o.Uk)("由于没有动态更新，在所有的Vue生命周期钩子中，只有"),(0,o._)("code",{class:"doc-token"},"beforeCreate"),(0,o.Uk)("和"),(0,o._)("code",{class:"doc-token"},"created"),(0,o.Uk)("会在SSR期间被调用。这意味着其他生命周期钩子里面的任何代码，如"),(0,o._)("code",{class:"doc-token"},"beforeMount"),(0,o.Uk)("或"),(0,o._)("code",{class:"doc-token"},"mounted"),(0,o.Uk)("将只在客户端执行。")],-1),r=(0,o._)("p",null,[(0,o.Uk)("另外需要注意的是，你应该避免在"),(0,o._)("code",{class:"doc-token"},"beforeCreate"),(0,o.Uk)("和"),(0,o._)("code",{class:"doc-token"},"created"),(0,o.Uk)("中产生全局副作用的代码，例如用"),(0,o._)("code",{class:"doc-token"},"setInterval"),(0,o.Uk)("设置计时器。在只有客户端的代码中，我们可以设置一个定时器，然后在"),(0,o._)("code",{class:"doc-token"},"beforeUnmount"),(0,o.Uk)("或"),(0,o._)("code",{class:"doc-token"},"destroyed"),(0,o.Uk)("中拆掉它。然而，由于销毁钩子不会在SSR期间被调用，定时器将永远留在身边。为了避免这种情况，把你的副作用代码移到"),(0,o._)("code",{class:"doc-token"},"beforeMount"),(0,o.Uk)("或"),(0,o._)("code",{class:"doc-token"},"mounted"),(0,o.Uk)("中去。")],-1),u=(0,o._)("p",null,"在编写纯客户端代码时，我们已经习惯了每次都在一个新的上下文中评估我们的代码。然而，Node.js服务器是一个长期运行的进程。当我们的代码被要求进入进程时，它将被评估一次，然后它将留在内存中。这意味着如果你创建了一个单例对象，它将在每个传入的请求中被共享。",-1),d=(0,o._)("p",null,"因此， Quasar CLI 为每个请求创建一个新的根Vue实例，并有一个新的Router和Vuex Store实例。这类似于每个用户将在自己的浏览器中使用一个新的应用实例。如果我们在多个请求中使用一个共享实例，将很容易导致跨请求的状态污染。",-1),_=(0,o._)("p",null,"与其直接创建Router和Vuex Store实例，你将暴露一个工厂函数，可以重复执行，为每个请求创建新鲜的应用程序实例。",-1),i=(0,o._)("pre",{class:"doc-code language-js"},[(0,o._)("code",{class:"doc-code__inner doc-code__inner--prerendered language-js"},[(0,o._)("span",{class:"token comment"},"// src/router/index.js"),(0,o.Uk)("\n"),(0,o._)("span",{class:"token keyword"},"export"),(0,o.Uk)(),(0,o._)("span",{class:"token keyword"},"default"),(0,o.Uk)(),(0,o._)("span",{class:"token keyword"},"function"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"("),(0,o._)("span",{class:"token comment"},"/* { store, ssrContext } */"),(0,o._)("span",{class:"token punctuation"},")"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"{"),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token keyword"},"const"),(0,o.Uk)(" Router "),(0,o._)("span",{class:"token operator"},"="),(0,o.Uk)(),(0,o._)("span",{class:"token keyword"},"new"),(0,o.Uk)(),(0,o._)("span",{class:"token class-name"},"VueRouter"),(0,o._)("span",{class:"token punctuation"},"("),(0,o._)("span",{class:"token punctuation"},"{"),(0,o._)("span",{class:"token operator"},"..."),(0,o._)("span",{class:"token punctuation"},"}"),(0,o._)("span",{class:"token punctuation"},")"),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token keyword"},"return"),(0,o.Uk)(" Router\n"),(0,o._)("span",{class:"token punctuation"},"}"),(0,o.Uk)("\n")])],-1),U=(0,o._)("pre",{class:"doc-code language-js"},[(0,o._)("code",{class:"doc-code__inner doc-code__inner--prerendered language-js"},[(0,o._)("span",{class:"token comment"},"// src/store/index.js"),(0,o.Uk)("\n"),(0,o._)("span",{class:"token keyword"},"export"),(0,o.Uk)(),(0,o._)("span",{class:"token keyword"},"default"),(0,o.Uk)(),(0,o._)("span",{class:"token keyword"},"function"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"("),(0,o._)("span",{class:"token comment"},"/* { ssrContext } */"),(0,o._)("span",{class:"token punctuation"},")"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"{"),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token keyword"},"const"),(0,o.Uk)(" Store "),(0,o._)("span",{class:"token operator"},"="),(0,o.Uk)(),(0,o._)("span",{class:"token keyword"},"new"),(0,o.Uk)(),(0,o._)("span",{class:"token class-name"},[(0,o.Uk)("Vuex"),(0,o._)("span",{class:"token punctuation"},"."),(0,o.Uk)("Store")]),(0,o._)("span",{class:"token punctuation"},"("),(0,o._)("span",{class:"token punctuation"},"{"),(0,o._)("span",{class:"token operator"},"..."),(0,o._)("span",{class:"token punctuation"},"}"),(0,o._)("span",{class:"token punctuation"},")"),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token keyword"},"return"),(0,o.Uk)(" Store\n"),(0,o._)("span",{class:"token punctuation"},"}"),(0,o.Uk)("\n")])],-1),m=(0,o.Uk)("如果你使用"),g=(0,o.Uk)("Vuex modules"),h=(0,o.Uk)("，别忘了将状态导出为一个函数，否则将创建一个单例。"),y=(0,o._)("pre",{class:"doc-code language-js"},[(0,o._)("code",{class:"doc-code__inner doc-code__inner--prerendered language-js"},[(0,o._)("span",{class:"token comment"},"// src/store/myModule/state.js"),(0,o.Uk)("\n"),(0,o._)("span",{class:"token keyword"},"export"),(0,o.Uk)(),(0,o._)("span",{class:"token keyword"},"default"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"("),(0,o._)("span",{class:"token punctuation"},")"),(0,o.Uk)(),(0,o._)("span",{class:"token operator"},"=>"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"("),(0,o._)("span",{class:"token punctuation"},"{"),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token operator"},"..."),(0,o.Uk)("\n"),(0,o._)("span",{class:"token punctuation"},"}"),(0,o._)("span",{class:"token punctuation"},")"),(0,o.Uk)("\n\n")])],-1),f=(0,o._)("p",null,[(0,o.Uk)("通用代码不能假定对特定平台API的访问，所以如果你的代码直接使用浏览器专用的globals，如"),(0,o._)("code",{class:"doc-token"},"window"),(0,o.Uk)("或"),(0,o._)("code",{class:"doc-token"},"document"),(0,o.Uk)("，它们在Node.js中执行时将会出现错误，反之亦然。")],-1),w=(0,o.Uk)("对于在服务器和客户端之间共享但使用不同平台API的任务，建议将特定平台的实现封装在一个通用API中，或者使用为你做这件事的库。例如，"),b=(0,o.Uk)("Axios"),S=(0,o.Uk)("是一个HTTP客户端，为服务器和客户端暴露了相同的API。"),v=(0,o._)("p",null,"对于仅适用于浏览器的API，常见的方法是在仅适用于客户端的生命周期钩子中懒散地访问它们。",-1),j=(0,o._)("p",null,"请注意，如果第三方库的编写没有考虑到通用性，那么将其集成到服务器渲染的应用中可能会很麻烦。你可能*能够通过模拟一些球状物来让它工作，但这是很困难的，而且可能会干扰到其他库的环境检测代码。",-1),x=(0,o.Uk)("当你把第三方库添加到你的项目中时(通过"),C=(0,o.Uk)("Boot File"),R=(0,o.Uk)(" )，要考虑到它是否可以在服务器和客户端上运行。如果它需要只在服务器上运行或只在客户端运行，那么请在quasar.conf.js中指定："),q=(0,o._)("pre",{class:"doc-code language-js"},[(0,o._)("code",{class:"doc-code__inner doc-code__inner--prerendered language-js"},[(0,o._)("span",{class:"token comment"},"// quasar.conf.js"),(0,o.Uk)("\n"),(0,o._)("span",{class:"token keyword"},"return"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"{"),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token comment"},"// ..."),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token literal-property property"},"boot"),(0,o._)("span",{class:"token operator"},":"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"["),(0,o.Uk)("\n    "),(0,o._)("span",{class:"token string"},"'some-boot-file'"),(0,o._)("span",{class:"token punctuation"},","),(0,o.Uk)(),(0,o._)("span",{class:"token comment"},"// runs on both server & client"),(0,o.Uk)("\n    "),(0,o._)("span",{class:"token punctuation"},"{"),(0,o.Uk)(),(0,o._)("span",{class:"token literal-property property"},"path"),(0,o._)("span",{class:"token operator"},":"),(0,o.Uk)(),(0,o._)("span",{class:"token string"},"'some-other'"),(0,o._)("span",{class:"token punctuation"},","),(0,o.Uk)(),(0,o._)("span",{class:"token literal-property property"},"server"),(0,o._)("span",{class:"token operator"},":"),(0,o.Uk)(),(0,o._)("span",{class:"token boolean"},"false"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"}"),(0,o.Uk)(),(0,o._)("span",{class:"token comment"},"// this boot file gets embedded only on client-side"),(0,o.Uk)("\n    "),(0,o._)("span",{class:"token punctuation"},"{"),(0,o.Uk)(),(0,o._)("span",{class:"token literal-property property"},"path"),(0,o._)("span",{class:"token operator"},":"),(0,o.Uk)(),(0,o._)("span",{class:"token string"},"'third'"),(0,o._)("span",{class:"token punctuation"},","),(0,o.Uk)(),(0,o._)("span",{class:"token literal-property property"},"client"),(0,o._)("span",{class:"token operator"},":"),(0,o.Uk)(),(0,o._)("span",{class:"token boolean"},"false"),(0,o.Uk)(),(0,o._)("span",{class:"token punctuation"},"}"),(0,o.Uk)(),(0,o._)("span",{class:"token comment"},"// this boot file gets embedded only on server-side"),(0,o.Uk)("\n  "),(0,o._)("span",{class:"token punctuation"},"]"),(0,o.Uk)("\n"),(0,o._)("span",{class:"token punctuation"},"}"),(0,o.Uk)("\n")])],-1),I=(0,o._)("p",null,"在SSR过程中，我们基本上是在渲染我们的应用程序的 “快照”，所以如果应用程序依赖于一些异步数据，这些数据需要在我们开始渲染过程之前被预取和解决。",-1),P=(0,o.Uk)("Quasar CLI "),A=(0,o.Uk)("PreFetch Feature"),H=(0,o.Uk)("就是为了解决这个问题。花点时间来阅读一下。"),V={class:"doc-note"},W=(0,o.Uk)("本页部分内容摘自官方"),T=(0,o.Uk)("Vue.js SSR指南"),Q=(0,o.Uk)("。");function M(n,s,e,M,B,D){const F=(0,o.up)("doc-link"),L=(0,o.up)("q-separator"),N=(0,o.up)("doc-page");return(0,o.wg)(),(0,o.j4)(N,{"meta-title":M.metaTitle,title:"编写通用代码",nav:M.nav,toc:M.toc,"meta-desc":M.metaDesc},{default:(0,o.w5)((()=>[a,(0,o._)("p",null,[t,(0,o.Wm)(F,{to:"https://cdn.quasar.dev/img/ssr-build.png",title:"Quasar SSR Build System"},{default:(0,o.w5)((()=>[c])),_:1})]),(0,o._)("h2",{id:"服务器上的数据反应性",class:"doc-heading doc-h2",onClick:s[0]||(s[0]=n=>M.copyHeading("服务器上的数据反应性"))},"服务器上的数据反应性"),l,k,(0,o._)("h2",{id:"组件生命周期钩子",class:"doc-heading doc-h2",onClick:s[1]||(s[1]=n=>M.copyHeading("组件生命周期钩子"))},"组件生命周期钩子"),p,r,(0,o._)("h2",{id:"避免有状态的单例",class:"doc-heading doc-h2",onClick:s[2]||(s[2]=n=>M.copyHeading("避免有状态的单例"))},"避免有状态的单例"),u,d,_,i,U,(0,o._)("p",null,[m,(0,o.Wm)(F,{to:"https://vuex.vuejs.org/guide/modules.html"},{default:(0,o.w5)((()=>[g])),_:1}),h]),y,(0,o._)("h2",{id:"访问特定平台的api",class:"doc-heading doc-h2",onClick:s[3]||(s[3]=n=>M.copyHeading("访问特定平台的api"))},"访问特定平台的API"),f,(0,o._)("p",null,[w,(0,o.Wm)(F,{to:"https://github.com/axios/axios"},{default:(0,o.w5)((()=>[b])),_:1}),S]),v,(0,o._)("h2",{id:"启动文件",class:"doc-heading doc-h2",onClick:s[4]||(s[4]=n=>M.copyHeading("启动文件"))},"启动文件"),j,(0,o._)("p",null,[x,(0,o.Wm)(F,{to:"/quasar-cli/boot-files"},{default:(0,o.w5)((()=>[C])),_:1}),R]),q,(0,o._)("h2",{id:"数据预取和状态",class:"doc-heading doc-h2",onClick:s[5]||(s[5]=n=>M.copyHeading("数据预取和状态"))},"数据预取和状态"),I,(0,o._)("p",null,[P,(0,o.Wm)(F,{to:"/quasar-cli/prefetch-feature"},{default:(0,o.w5)((()=>[A])),_:1}),H]),(0,o.Wm)(L,{class:"q-mt-xl"}),(0,o._)("blockquote",V,[(0,o._)("p",null,[W,(0,o.Wm)(F,{to:"https://ssr.vuejs.org/guide/universal.html#data-reactivity-on-the-server"},{default:(0,o.w5)((()=>[T])),_:1}),Q])])])),_:1},8,["meta-title","nav","toc","meta-desc"])}var B=e(17536);const D={name:"DocMarkdownPage",setup(){return{metaTitle:"编写通用代码",metaDesc:"关于如何为 Quasar 服务器端渲染应用程序编写代码的指南。",nav:[{name:"简介",category:"开发 SSR",path:"/quasar-cli/developing-ssr/introduction",dir:"left"},{name:"升级指南",category:"开发 SSR",path:"/quasar-cli/developing-ssr/ssr-upgrade-guide",dir:"right"}],toc:[{id:"服务器上的数据反应性",title:"服务器上的数据反应性"},{id:"组件生命周期钩子",title:"组件生命周期钩子"},{id:"避免有状态的单例",title:"避免有状态的单例"},{id:"访问特定平台的api",title:"访问特定平台的API"},{id:"启动文件",title:"启动文件"},{id:"数据预取和状态",title:"数据预取和状态"}],copyHeading:B.Et}}};var F=e(74260);const L=(0,F.Z)(D,[["render",M]]),N=L}}]);